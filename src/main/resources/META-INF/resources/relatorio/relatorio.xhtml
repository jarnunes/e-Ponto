<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/templates/template-crud.xhtml" xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:jt="https://jnunes.com/jsf/facelets"
                xmlns:jn="http://xmlns.jcp.org/jsf/composite/resources/components">

    <!--@elvariable id="viewParams" type="java.util.HashMap" -->
    <f:metadata>
        <f:viewAction action="#{relatorioController.beforeInit()}"/>
    </f:metadata>

    <ui:define name="toolbar">
        <c:set var="controller" value="#{relatorioController}"/>
        <p:toolbarGroup id="toolbarGroup">
            <p:commandButton id="continuar" value="#{msg[controller.disableDownload
                ? 'relatorio.novo' : 'relatorio.edit']}" icon="bi bi-plus-lg" styleClass="mr-1"
                action="#{controller.continuar()}" rendered="#{not controller.editMode}"
                update="@form" disabled="#{controller.disabled}"/>
            <p:commandButton id="cancel" icon="bi bi-arrow-left" styleClass="mr-1"
                action="#{controller.resetValues()}" update="@form" rendered="#{controller.editMode}"/>
            <p:commandButton id="save" value="#{msg['save']}" styleClass="mr-1"
                action="#{controller.salvarRelatorio()}" rendered="#{controller.editMode}"
                update="form:toolbarPanelGroup"/>
            <p:commandButton id="download" value="#{msg['relatorio.download']}" ajax="false"
                styleClass="mr-1" icon="bi bi-file-earmark-text" disabled="#{controller.disableDownload}">
                <p:fileDownload value="#{relatorioController.obterArquivo()}"/>
            </p:commandButton>
        </p:toolbarGroup>
    </ui:define>

    <ui:define name="searchPanel">
        <jn:inputGroupBtnSearch id="data" label="Data" action="#{relatorioController.buscarRelatorio()}"
                                styleClass="col-12" update="form:resultPanelGroup form:toolbarPanelGroup" required="true"
                                disabled="#{relatorioController.disabled}">
            <p:datePicker id="dateTime" value="#{relatorioController.form.localDate}" pattern="MM/yyyy" required="true"
                         styleClass=" " disabled="#{relatorioController.disabled}">
                <p:ajax process="@this" immediate="true" />
            </p:datePicker>
        </jn:inputGroupBtnSearch>
    </ui:define>

    <ui:define name="resultPanel">
        <p:dataTable var="diaTrabalho" value="#{relatorioController.form.diasTrabalho}"
            emptyMessage="Nenhum registro encontrado!">

            <p:columnGroup type="header">
                <p:row>
                    <p:column  headerText="Dia" rowspan="2" style="width: 100px; text-align: center" styleClass="tcenter"/>
                    <p:column headerText="Entrada" rowspan="2" style="width: 100px; text-align: center"/>
                    <p:column headerText="Intervalo" colspan="2" style="width: 200px; text-align: center"/>
                    <p:column headerText="Saída" rowspan="2" style="width: 100px; text-align: center"/>
                    <p:column headerText="Crédito" rowspan="2" style="width: 100px; text-align: center"/>
                    <p:column headerText="Observação" rowspan="2"/>
                </p:row>
                <p:row>
                    <p:column headerText="Início" style="width: 100px; text-align: center"/>
                    <p:column headerText="Fim" style="width: 200px; text-align: center"/>
                </p:row>
            </p:columnGroup>

            <jt:column id="diaTrabalho" value="#{help.toDay(diaTrabalho.dia)}" style="text-align: center"/>
            <jt:column id="entrada" value="#{diaTrabalho.horaEntrada}"/>
            <jt:column id="inicioIntervalo" value="#{diaTrabalho.inicioIntervalo}"/>
            <jt:column id="fimIntervalo" value="#{diaTrabalho.fimIntervalo}"/>
            <jt:column id="saida" value="#{diaTrabalho.horaSaida}"/>
            <jt:column id="credito" value="#{diaTrabalho.credito}"/>
            <jt:column id="observacao" value="#{diaTrabalho.observacao}"/>
         </p:dataTable>

        <h:outputStylesheet>
            body .tcenter{
                text-align: center !important;
            }
        </h:outputStylesheet>
    </ui:define>

    <ui:define name="editPanel">
        <c:set var="pageTitle" value="${msg['relatorio.title']}" scope="request"/>

        <h:panelGroup id="gerandoRelatorio" rendered="#{not empty relatorioController.form.localDate}" styleClass="col-12">
            <p:dataTable id="datatableDiasTrabalho" var="dia" value="#{relatorioController.form.diasTrabalho}"
                         editMode="cell" editable="true" widgetVar="diasTrabalho">
                <p:columnGroup type="header">
                    <p:row>
                        <p:column  headerText="Dia" rowspan="2" style="width: 100px; text-align: center" styleClass="tcenter"/>
                        <p:column headerText="Entrada" rowspan="2" style="width: 100px; text-align: center"/>
                        <p:column headerText="Intervalo" colspan="2" style="width: 200px; text-align: center"/>
                        <p:column headerText="Saída" rowspan="2" style="width: 100px; text-align: center"/>
                        <p:column headerText="Crédito" rowspan="2" style="width: 100px; text-align: center"/>
                        <p:column headerText="Observação" rowspan="2"/>
                    </p:row>
                    <p:row>
                        <p:column headerText="Início" style="width: 100px; text-align: center"/>
                        <p:column headerText="Fim" style="width: 200px; text-align: center"/>
                    </p:row>
                </p:columnGroup>

                <p:column style="text-align: center">
                    <h:outputText value="#{help.toDay(dia.dia)}" style=""/>
                </p:column>

                <p:column styleClass="time-column-edit" style="text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.horaEntrada}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.horaEntrada}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit"
                          style="text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.inicioIntervalo}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.inicioIntervalo}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit"
                          style="text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.fimIntervalo}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.fimIntervalo}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit" style="width: 100px; text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.horaSaida}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.horaSaida}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit" style="width: 100px; text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.credito}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputNumber value="#{dia.credito}" decimalPlaces="2"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Observação">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.observacao}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{dia.observacao}" style="width: 100%"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:columnGroup type="footer">
                    <p:row>
                        <p:column colspan="5" style="text-align:right" footerText="Crédito Mês Atual: "/>
                        <p:column style="text-align: center">
                            <f:facet name="footer">
                                <h:outputText value="#{relatorioController.getSomatorioCreditoDoRelatorioEmEdicao()}"/>
                            </f:facet>
                        </p:column>
                        <p:column colspan="1" style="text-align:right"/>
                    </p:row>
                </p:columnGroup>

            </p:dataTable>
        </h:panelGroup>

        <h:outputStylesheet>
            .time-column-edit input {
                width: 100px;
            }
        </h:outputStylesheet>
    </ui:define>
</ui:composition>
