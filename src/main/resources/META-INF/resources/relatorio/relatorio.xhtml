<?xml version="1.0" encoding="UTF-8"?>
<ui:composition template="/templates/template-crud.xhtml" xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui" xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:jt="https://jnunes.com/jsf/facelets"
                xmlns:jn="http://xmlns.jcp.org/jsf/composite/resources/components">

    <!--@elvariable id="viewParams" type="java.util.HashMap" -->
    <f:metadata>
        <f:viewAction action="#{relatorioController.beforeInit()}"/>
    </f:metadata>

    <ui:param name="controller" value="#{relatorioController}"/>
    <ui:define name="toolbar">
        <c:set var="controller" value="#{relatorioController}"/>
        <p:toolbarGroup id="toolbarGroup">
            <p:commandButton id="continuar" value="#{msg[controller.disableDownload
                ? 'relatorio.novo' : 'relatorio.edit']}" icon="bi bi-plus-lg" styleClass="mr-1"
                action="#{controller.continuar()}" rendered="#{not controller.editMode}"
                update="@form" disabled="#{controller.disabled}"/>
            <p:commandButton id="cancel" icon="bi bi-arrow-left" styleClass="mr-1"
                action="#{controller.cancel()}" update="@form" rendered="#{controller.editMode}"/>
            <p:commandButton id="save" value="#{msg['save']}" styleClass="mr-1"
                action="#{controller.salvarRelatorio()}" rendered="#{controller.editMode}"
                update="form:toolbarPanelGroup"/>
            <p:commandButton id="download" value="#{msg['relatorio.download']}"
                styleClass="mr-1" icon="bi bi-file-earmark-text" disabled="#{controller.disableDownload}">
                <p:fileDownload value="#{controller.file}"/>
            </p:commandButton>
        </p:toolbarGroup>
    </ui:define>

    <ui:define name="searchPanel">
        <jn:inputGroupBtnSearch id="data" label="Data" action="#{relatorioController.buscarRelatorio()}"
                                styleClass="col-12" update="form:resultPanelGroup form:toolbarPanelGroup" required="true"
                                disabled="#{relatorioController.disabled}">
            <jn:dateTime id="dateTime" value="#{relatorioController.localDate}" pattern="MM/yyyy" required="true"
                         styleClass=" " disabled="#{relatorioController.disabled}"/>
        </jn:inputGroupBtnSearch>
    </ui:define>

    <ui:define name="resultPanel">
        <p:dataTable var="row" rowKey="#{row.id}" value="#{relatorioController.form.relatorios}"
                     emptyMessage="Nenhum registro encontrado!">
            <p:column style="width: 5px ">
                <p:rowToggler/>
            </p:column>
            <p:column headerText="Referência" style="width: 20px">
                <h:outputText value="#{row.referencia}"/>
            </p:column>
            <p:column headerText="Crédito" style="width: 70px">
                <h:outputText value="#{row.credito}"/>
            </p:column>
            <p:rowExpansion styleClass="col-12">
                <p:dataTable id="datatableRowExpansion" var="diaTrabalho" value="#{row.diasTrabalho}">
                    <p:column headerText="Dia" style="width: 20px">
                        <h:outputText value="#{help.toDay(diaTrabalho.dia)}"/>
                    </p:column>

                    <p:column headerText="Entrada" style="width: 70px">
                        <h:outputText value="#{diaTrabalho.horaEntrada}"/>
                    </p:column>

                    <p:column headerText="Inícios" style="width: 70px">
                        <h:outputText value="#{diaTrabalho.inicioIntervalo}"/>
                    </p:column>

                    <p:column headerText="Fim" style="width: 70px">
                        <h:outputText value="#{diaTrabalho.fimIntervalo}"/>
                    </p:column>

                    <p:column headerText="Saída" style="width: 70px">
                        <h:outputText value="#{diaTrabalho.horaSaida}"/>
                    </p:column>

                    <p:column headerText="Crédito" style="width: 70px">
                        <h:outputText value="#{diaTrabalho.credito}"/>
                    </p:column>
                    <p:column headerText="Observação">
                        <h:outputText value="#{diaTrabalho.observacao}"/>
                    </p:column>


                </p:dataTable>
            </p:rowExpansion>
        </p:dataTable>
    </ui:define>

    <ui:define name="editPanel">
        <c:set var="pageTitle" value="${msg['relatorio.title']}" scope="request"/>

        <h:panelGroup id="gerandoRelatorio" rendered="#{not empty relatorioController.localDate}" styleClass="col-12">
            <p:dataTable id="datatableDiasTrabalho" var="dia" value="#{relatorioController.diasTrabalho}"
                         editMode="cell" editable="true" widgetVar="diasTrabalho">

                <p:columnGroup type="header">
                    <p:row>
                        <p:column headerText="Dia" style="width: 100px; text-align: center"/>
                        <p:column headerText="Entrada" style="width: 100px; text-align: center"/>
                        <p:column headerText="Intervalo" colspan="2" style="width: 200px; text-align: center"/>
                        <p:column headerText="Saída" style="width: 100px; text-align: center"/>
                        <p:column headerText="Crédito" style="width: 100px; text-align: center"/>
                        <p:column headerText="Observação"/>
                    </p:row>
                </p:columnGroup>

                <p:column style="text-align: center">
                    <h:outputText value="#{help.toDay(dia.dia)}" style=""/>
                </p:column>

                <p:column styleClass="time-column-edit" style="text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.horaEntrada}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.horaEntrada}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit"
                          style="text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.inicioIntervalo}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.inicioIntervalo}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit"
                          style="text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.fimIntervalo}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.fimIntervalo}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit" style="width: 100px; text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.horaSaida}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{dia.horaSaida}" timeOnly="true" pattern="HH:mm">
                                <p:ajax listener="#{relatorioController.onCellEditListener(dia)}"
                                        update="form:datatableDiasTrabalho"/>
                            </p:datePicker>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column styleClass="time-column-edit" style="width: 100px; text-align: center">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.credito}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputNumber value="#{dia.credito}" decimalPlaces="2"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Observação">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{dia.observacao}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{dia.observacao}" style="width: 100%"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:columnGroup type="footer">
                    <p:row>
                        <p:column colspan="5" style="text-align:right" footerText="Crédito Mês Atual: "/>
                        <p:column style="text-align: center">
                            <f:facet name="footer">
                                <h:outputText value="#{relatorioController.getSomatorioCreditoDoRelatorioEmEdicao()}"/>
                            </f:facet>
                        </p:column>
                        <p:column colspan="1" style="text-align:right"/>
                    </p:row>
                </p:columnGroup>

            </p:dataTable>
        </h:panelGroup>

        <h:outputStylesheet>
            .time-column-edit input {
                width: 100px;
            }
        </h:outputStylesheet>
    </ui:define>
</ui:composition>
